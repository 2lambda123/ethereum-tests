# Verify a valid withdrawal on a single block

validIndexWithdrawals:
  genesisBlockHeader:
    bloom: 0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
    coinbase: 0x8888f1f195afa192cfee860698584c030f4c9db1
    difficulty: 131072
    extraData: 0x42
    gasLimit: 3141592
    gasUsed: 0
    mixHash: 0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421
    nonce: 0x0102030405060708
    number: 0
    parentHash: 0x0000000000000000000000000000000000000000000000000000000000000000
    receiptTrie: 0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421
    stateRoot: 0xf99eb1626cfa6db435c0836235942d7ccaa935f1ae247d3f1c21e495685f903a
    timestamp: 0x54c98c81
    transactionsTrie: 0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421
    uncleHash: 0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347
# withdrawalsHash could be added here
#  sealEngine: NoProof


  pre:
    0xa94f5374fce5edbc8e2a8697c15331677e6ebf0b:
      balance: '10000000000'
      nonce: '1'
      code: ''
      storage: {}
    # Check balance of a given account
    0x00000000000000000000000000000000000c0deA:
      balance: '0'
      nonce: '0'
      code: |
          :yul {
            let accountAddress := calldataload(4)
            sstore(accountAddress, balance(accountAddress))
          }
      storage: {}
    # Withdrawal recipients have code to set storage unconditionally,
    # to verify the EVM is not triggered by the withdrawal.
    0x000000000000000000000000000000000000000a:
      balance: '0'
      nonce: '0'
      code: |
          :yul {
            sstore(0, 1)
          }
      storage: {}
    0x000000000000000000000000000000000000000b:
      balance: '0'
      nonce: '0'
      code: |
          :yul {
            sstore(0, 1)
          }
      storage: {}

  blocks:
  - transactions:
    ## Add transaction to check balance of the accounts during this block via contract
    ## Add a second block to do the same check on a subsequent block
    ## Add code to accounts which would set a state variable,
    ## to make sure that EVM is not triggered
    ## Also check that the nonce is not increased on the withdrawal accts
    - data: :abi f(address) 0x000000000000000000000000000000000000000a
      accessList: []
      gasLimit: 50000   
      maxPriorityFeePerGas:   0
      maxFeePerGas:        1000
      nonce: auto
      secretKey: 45a915e4d060149eb4365960e6a7a45f334393093061116b197e3240065ff2d8
      to: 0x00000000000000000000000000000000000c0deA
      value: 0x0
    - data: :abi f(address) 0x000000000000000000000000000000000000000b
      accessList: []
      gasLimit: 50000   
      maxPriorityFeePerGas:   0
      maxFeePerGas:        1000
      nonce: auto
      secretKey: 45a915e4d060149eb4365960e6a7a45f334393093061116b197e3240065ff2d8
      to: 0x00000000000000000000000000000000000c0deA
      value: 0x0
    withdrawals:
    - index: 0
      address: 0x000000000000000000000000000000000000000a
      amount: '1234'
    - index: 1
      address: 0x000000000000000000000000000000000000000b
      amount: '1234'
    - index: 2
      address: 0x000000000000000000000000000000000000000a
      amount: '1234'
    - index: 3
      address: 0x000000000000000000000000000000000000000b
      amount: '1234'

  expect:
  - network:
    - ">=Shanghai"
    result:
      0x000000000000000000000000000000000000000a:
        balance: '2468'
        nonce: '0'
        storage: {}
      0x000000000000000000000000000000000000000b:
        balance: '2468'
        nonce: '0'
        storage: {}
      0x00000000000000000000000000000000000c0deA:
        balance: '0'
        nonce: '0'
        storage:
          0x000000000000000000000000000000000000000a: 0
          0x000000000000000000000000000000000000000b: 0
