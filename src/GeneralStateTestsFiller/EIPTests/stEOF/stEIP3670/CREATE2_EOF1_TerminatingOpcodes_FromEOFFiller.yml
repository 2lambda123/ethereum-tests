# Tests CREATE2 called from EOF code, is able to deploy code with terminating
# opcodes (STOP, RETURN, REVERT, INVALID)
CREATE2_EOF1_TerminatingOpcodes_FromEOF:
  env:
    currentCoinbase: 2adc25665018aa1fe0e6bc666dac8fc2697ff9ba
    currentDifficulty: '0x020000'
    currentGasLimit: '89128960'
    currentBaseFee: '10'
    currentNumber: '1'
    currentTimestamp: '1000'
    previousHash: 5e20a0453cecd065ea59c37ac63e079ee08998b6045136a8ce6635c7912ec0b6

  pre:
    a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
      balance: 200000000
      code: ''
      nonce: 0
      storage: {}
    b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
      balance: 0
      # code: ":yul { calldatacopy(0, 0, calldatasize()) sstore(0, create2(0, 0, calldatasize(), 0)) sstore(1, 1) }"
      code: ":raw 0xEF00010100170036600060003760003660006000f5600055600160015500"
      nonce: 0
      storage: {}

  transaction:
    data: 
      # deployed code section: 'PUSH1 0 STOP'
      - ':label deploying_valid_eof1_stop :yul { mstore(0, 0xef00010100030060000000000000000000000000000000000000000000000000) return(0, 10) }'
      # deployed code section: 'PUSH1 0 PUSH1 0 RETURN'
      - ':label deploying_valid_eof1_return :yul { mstore(0, 0xef00010100050060006000f30000000000000000000000000000000000000000) return(0, 12) }'
      # deployed code section: 'PUSH1 1 PUSH1 0 SSTORE PUSH1 0 PUSH1 0 REVERT'
      - ':label deploying_valid_eof1_revert :yul { mstore(0, 0xef000101000a00600160005560006000fd000000000000000000000000000000)  return(0, 17) }'
      # deployed code section: 'PUSH1 0 INVALID'
      - ':label deploying_valid_eof1_invalid :yul { mstore(0, 0xef0001010003006000fe00000000000000000000000000000000000000000000) return(0, 10) }'

      # initcode code section: ':yul { mstore(0, 0xef00010100030060000000000000000000000000000000000000000000000000) return(0, 10) }'
      # deployed code section: 'PUSH1 0 STOP'
      - ':label eof1_initcode_deploying_valid_eof1_stop :raw 0xef0001010029007fef00010100030060000000000000000000000000000000000000000000000000600052600a6000f3'
      # initcode code section: ':yul { mstore(0, 0xef00010100050060006000f30000000000000000000000000000000000000000) return(0, 12) }'
      # deployed code section: 'PUSH1 0 PUSH1 0 RETURN'
      - ':label eof1_initcode_deploying_valid_eof1_return :raw 0xef0001010029007fef00010100050060006000f30000000000000000000000000000000000000000600052600c6000f3'
      # initcode code section: ':yul { mstore(0, 0xef000101000a00600160005560006000fd000000000000000000000000000000)  return(0, 17) }'
      # deployed code section: 'PUSH1 1 PUSH1 0 SSTORE PUSH1 0 PUSH1 0 REVERT'
      - ':label eof1_initcode_deploying_valid_eof1_revert :raw 0xef0001010029007fef000101000a00600160005560006000fd00000000000000000000000000000060005260116000f3'
      # initcode code section: ':yul { mstore(0, 0xef0001010003006000fe00000000000000000000000000000000000000000000) return(0, 10) }'
      # deployed code section: 'PUSH1 0 INVALID'
      - ':label eof1_initcode_deploying_valid_eof1_invalid :raw 0xef0001010029007fef0001010003006000fe00000000000000000000000000000000000000000000600052600a6000f3'
      # initcode code section: ':yul { mstore(0, 0xef0001010003006000fe00000000000000000000000000000000000000000000) return(0, 10) }'

      # deployed code section: 'PUSH1 0 STOP'
      # Note: return is already used/tested in previous eof initcode
      # initcode code section: ':yul { mstore(0, ef00010100030060000000000000000000000000000000000000000000000000) return(0, 10) stop() }'
      - ':label eof1_initcode_with_terminating_opcode_stop :raw 0xef000101002a007fef00010100030060000000000000000000000000000000000000000000000000600052600a6000f300'
      # initcode code section: ':yul { mstore(0, 0xef00010100030060000000000000000000000000000000000000000000000000) return(0, 10) revert(0, 0) }'
      - ':label eof1_initcode_with_terminating_opcode_revert :raw 0xef000101002e007fef00010100030060000000000000000000000000000000000000000000000000600052600a6000f360006000fd'
      # initcode code section: :yul { mstore(0, 0xef00010100030060000000000000000000000000000000000000000000000000) return(0, 10) invalid() }'
      - ':label eof1_initcode_with_terminating_opcode_invalid :raw 0xef000101002a007fef00010100030060000000000000000000000000000000000000000000000000600052600a6000f3fe'

    gasLimit:
      - 15000000
    gasPrice: 10
    nonce: 0
    secretKey: 45a915e4d060149eb4365960e6a7a45f334393093061116b197e3240065ff2d8
    to: 'b94f5374fce5edbc8e2a8697c15331677e6ebf0b'
    value:
    - 0

  expect:
    - indexes:
       data: ':label deploying_valid_eof1_stop'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '0144766749B2d9936E989B9F058b29dc9ca366D4'
            '1': '1'
       0144766749B2d9936E989B9F058b29dc9ca366D4:
          nonce: 1
          code: '0xef000101000300600000'
          storage: {}
    - indexes:
       data: ':label deploying_valid_eof1_return'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': 'cb723ee1e9f83c8c4d3bb2d072bbe1f2b640c2f6'
            '1': '1'
       cb723ee1e9f83c8c4d3bb2d072bbe1f2b640c2f6:
          nonce: 1
          code: '0xef00010100050060006000f3'
          storage: {}

    - indexes:
       data: ':label deploying_valid_eof1_revert'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '78631f527116bcad0f483aF01D8aB2619dB2b397'
            '1': '1'
       78631f527116bcad0f483aF01D8aB2619dB2b397:
          nonce: 1
          code: '0xef000101000a00600160005560006000fd'
          storage: {}

    - indexes:
       data: ':label deploying_valid_eof1_invalid'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': 'd6e208982db258d98945ea2b3c57a09f1042d0e1'
            '1': '1'
       d6e208982db258d98945ea2b3c57a09f1042d0e1:
          nonce: 1
          code: '0xef0001010003006000fe'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_deploying_valid_eof1_stop'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '43Cb7FFAAB9F11BA4d8c1063F71f3382e13eE8B2'
            '1': '1'
       43Cb7FFAAB9F11BA4d8c1063F71f3382e13eE8B2:
          nonce: 1
          code: '0xef000101000300600000'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_deploying_valid_eof1_return'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': 'bcc715e0935dcba01eb323950591730e22f842f9'
            '1': '1'
       bcc715e0935dcba01eb323950591730e22f842f9:
          nonce: 1
          code: '0xef00010100050060006000f3'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_deploying_valid_eof1_revert'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '595E98aA8D223Fc135cb010aD96DaC871a650DB6'
            '1': '1'
       595E98aA8D223Fc135cb010aD96DaC871a650DB6:
          nonce: 1
          code: '0xef000101000a00600160005560006000fd'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_deploying_valid_eof1_invalid'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': 'fed70c19c3224a94c47da63d3d49633ab556aacf'
            '1': '1'
       fed70c19c3224a94c47da63d3d49633ab556aacf:
          nonce: 1
          code: '0xef0001010003006000fe'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_with_terminating_opcode_stop'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '5b6123EA01bf1962A50643f230D76D93Fb0B5544'
            '1': '1'
       5b6123EA01bf1962A50643f230D76D93Fb0B5544:
          nonce: 1
          code: '0xef000101000300600000'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_with_terminating_opcode_revert'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '74acFc033ad05a7d0FDbFe7a858cC7148b047F8d'
            '1': '1'
       74acFc033ad05a7d0FDbFe7a858cC7148b047F8d:
          nonce: 1
          code: '0xef000101000300600000'
          storage: {}

    - indexes:
       data: ':label eof1_initcode_with_terminating_opcode_invalid'
      network:
        - 'Merge+3540+3670+4750'
      result:
       a94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
       b94f5374fce5edbc8e2a8697c15331677e6ebf0b:
          nonce: 1
          storage:
            '0': '6FB71059490e1A677E0f842A2d8c23d88fE733f1'
            '1': '1'
       6FB71059490e1A677E0f842A2d8c23d88fE733f1:
          nonce: 1
          code: '0xef000101000300600000'
          storage: {}

